# 操作系统实验报告

##### 201840058 蒋潇鹏

## L0 hello-os

#### 实现库函数

在ICS中我已经实现了全部的库函数，这里我将他们直接移植过来了。

在stdio.c中我发现函数对共享内存进行了操作，并且printf对putch的调用不能保证输出的原子性，因此我在klib中实现了一个简单的自旋锁，并在这两个地方添加

#### 访问IO设备

这部分我直接魔改了L0的框架代码，把splash函数的调用移到了while(1)中，之后遍历每一个像素点，进行打印。

对于键盘输入，也可以将print_key中的操作魔改一下，当读取到Escape时，调用halt(0)

#### 绘制一个图片

首先我找了一张图片：
![](/home/birdium/os-workbench/kernel/mrs.jpeg)

之后用如下命令将其转换为一个rgb阵列：
```shell
convert mrs.jpeg mrs.rgb
xxd -i mrs.rgb mrs.c
```

这样在`mrs.c`文件中就有了我需要的一个大数组，在splash中用如下代码打印：
```C
  for (int x = 0; x < w; x ++) {
    for (int y = 0; y < h; y++) {
      int loc = (y * IMG_HEIGHT / h) * IMG_WIDTH + (x * IMG_WIDTH / w); 
      unsigned int col = (mrs_rgb[3 * loc] << 16) + 
                         (mrs_rgb[3 * loc + 1] << 8) +
                         (mrs_rgb[3 * loc + 2]);
      draw_tile(x, y, 1, 1, col);
    }
  }
```

## L1 pmm

#### 设计思路